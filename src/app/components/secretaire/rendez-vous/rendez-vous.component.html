<div class="p-6 bg-gray-100 min-h-screen">
  <div class="flex justify-between items-center mb-6">
    <h2 class="text-2xl font-bold text-gray-700">📅 Gestion des Rendez-vous</h2>
    <button
      (click)="openAddModal()"
      class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition flex items-center gap-2"
    >
      <span>➕</span>
      <span>Ajouter un rendez-vous</span>
    </button>
  </div>

  <!-- Loading State -->
  @if (isLoading) {
    <div class="flex justify-center items-center py-8">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
    </div>
  }

  <div class="bg-white shadow-lg rounded-xl overflow-hidden">
    <!-- Message si aucun rendez-vous -->
    @if (rendezvous.length === 0 && !isLoading) {
      <div class="p-8 text-center text-gray-500">
        <div class="text-6xl mb-4">📅</div>
        <h3 class="text-xl font-semibold mb-2">Aucun rendez-vous pour le moment</h3>
        <p class="text-gray-600">Commencez par ajouter votre premier rendez-vous</p>
      </div>
    }

    <!-- Table des rendez-vous -->
    @if (rendezvous.length > 0) {
      <div class="overflow-x-auto">
        <table class="min-w-full">
          <thead class="bg-blue-600 text-white">
          <tr>
            <th class="py-4 px-6 text-left font-semibold">ID</th>
            <th class="py-4 px-6 text-left font-semibold">Médecin</th>
            <th class="py-4 px-6 text-left font-semibold">Patient</th>
            <th class="py-4 px-6 text-left font-semibold">Date</th>
            <th class="py-4 px-6 text-left font-semibold">Heure</th>
            <th class="py-4 px-6 text-left font-semibold">Motif</th>
            <th class="py-4 px-6 text-left font-semibold">Statut</th>
            <th class="py-4 px-6 text-left font-semibold">Actions</th>
          </tr>
          </thead>
          <tbody>
            @for (rdv of rendezvous; track rdv.id) {
              <tr class="border-b hover:bg-gray-50 transition duration-200">
                <td class="py-4 px-6 font-medium">{{ rdv.id }}</td>
                <td class="py-4 px-6">
                  <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                      <span class="text-blue-600 text-sm">👨‍⚕️</span>
                    </div>
                    <div>
                      @for (med of medecins; track med.id){
                        @if (med.id === rdv.medecin_id ){
                      <div class="font-medium text-gray-900">
                        {{ med.user?.nom || 'N/A' }} {{ med.user?.prenom || '' }}
                      </div>
                      <div class="text-sm text-gray-500">
                        {{ med.specialite?.nom || 'Spécialité non définie' }}
                      </div>
                        }
                      }
                    </div>
                  </div>
                </td>
                <td class="py-4 px-6">
                  <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">
                      <span class="text-green-600 text-sm">👤</span>
                    </div>
                    <div>
                      @for (pat of patients; track pat.id){
                        @if (pat.id === rdv.patient_id ){
                          <div class="font-medium text-gray-900">
                            {{ pat.user?.nom || 'N/A' }} {{ pat.user?.prenom || '' }}
                          </div>
                          <div class="text-sm text-gray-500">
                            {{ pat.numero_patient || '' }}
                          </div>
                        }
                      }
                    </div>
                  </div>
                </td>
                <td class="py-4 px-6 font-medium">
                  {{ rdv.date_rendezvous | date:'dd/MM/yyyy' }}
                </td>
                <td class="py-4 px-6 font-medium">
                  <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-sm">
                    {{ rdv.heure_rendezvous }}
                  </span>
                </td>
                <td class="py-4 px-6">
                  <span class="text-gray-700 line-clamp-2" [title]="rdv.motif || 'Aucun motif'">
                    {{ rdv.motif || 'Aucun motif' }}
                  </span>
                </td>
                <td class="py-4 px-6">
                  <span
                    [ngClass]="{
                      'bg-green-100 text-green-800 border border-green-200': rdv.statut === 'confirme',
                      'bg-yellow-100 text-yellow-800 border border-yellow-200': rdv.statut === 'en_attente',
                      'bg-red-100 text-red-800 border border-red-200': rdv.statut === 'annule',
                      'bg-blue-100 text-blue-800 border border-blue-200': rdv.statut === 'termine',
                      'bg-gray-100 text-gray-800 border border-gray-200': !rdv.statut
                    }"
                    class="px-3 py-1.5 rounded-full text-xs font-semibold inline-flex items-center gap-1"
                  >
                    @switch (rdv.statut) {
                      @case ('confirme') { ✓ }
                      @case ('en_attente') { ⏱️ }
                      @case ('annule') { ✗ }
                      @case ('termine') { ✅ }
                    }
                    {{ getStatutLabel(rdv.statut) || 'N/A' }}
                  </span>
                </td>
                <td class="py-4 px-6">
                  <div class="flex gap-2">
                    <button
                      (click)="openEditModal(rdv)"
                      class="bg-yellow-500 text-white px-3 py-2 rounded-lg hover:bg-yellow-600 transition flex items-center gap-1"
                      title="Modifier"
                    >
                      <span>✏️</span>
                      <span class="text-sm">Modifier</span>
                    </button>
                    <button
                      (click)="deleteRendezVous(rdv.id)"
                      class="bg-red-600 text-white px-3 py-2 rounded-lg hover:bg-red-700 transition flex items-center gap-1"
                      title="Supprimer"
                    >
                      <span>🗑️</span>
                      <span class="text-sm">Supprimer</span>
                    </button>
                  </div>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    }
  </div>

  <!-- Modal -->
  @if (showModal) {
    <div class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
      <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
        <!-- Header -->
        <div class="border-b border-gray-200 p-6">
          <div class="flex items-center justify-between">
            <h3 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
              <span>{{ editing ? '✏️' : '➕' }}</span>
              <span>{{ editing ? 'Modifier le' : 'Nouveau' }} rendez-vous</span>
            </h3>
            <button
              (click)="closeModal()"
              class="text-gray-400 hover:text-gray-600 transition text-xl"
            >
              ✕
            </button>
          </div>
        </div>

        <!-- Form -->
        <form (ngSubmit)="saveRendezVous()" #rdvForm="ngForm" class="p-6 space-y-6">
          <!-- Patient et Médecin -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Sélection du Patient -->
            <div>
              <label class="block text-gray-700 font-semibold mb-3 flex items-center gap-2">
                <span class="w-6 h-6 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 text-sm">👤</span>
                Patient *
              </label>
              <select
                [(ngModel)]="selectedRdv.patient_id"
                name="patient_id"
                required
                class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:outline-none focus:border-blue-500 transition"
              >
                <option value="">Sélectionner un patient</option>
                @for (patient of patients; track patient.id) {
                  <option [value]="patient.id">
                    {{ getPatientLabel(patient) }}
                  </option>
                }
              </select>
            </div>

            <!-- Sélection du Médecin -->
            <div>
              <label class="block text-gray-700 font-semibold mb-3 flex items-center gap-2">
                <span class="w-6 h-6 bg-green-100 rounded-full flex items-center justify-center text-green-600 text-sm">👨‍⚕️</span>
                Médecin *
              </label>
              <select
                [(ngModel)]="selectedRdv.medecin_id"
                name="medecin_id"
                required
                class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:outline-none focus:border-blue-500 transition"
              >
                <option value="">Sélectionner un médecin</option>
                @for (medecin of medecins; track medecin.id) {
                  <option [value]="medecin.id">
                    {{ getMedecinLabel(medecin) }}
                  </option>
                }
              </select>
            </div>
          </div>

          <!-- Date et Heure -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label class="block text-gray-700 font-semibold mb-3 flex items-center gap-2">
                <span class="w-6 h-6 bg-purple-100 rounded-full flex items-center justify-center text-purple-600 text-sm">📅</span>
                Date *
              </label>
              <input
                type="date"
                [(ngModel)]="selectedRdv.date_rendezvous"
                name="date_rendezvous"
                required
                [min]="getTodayDate()"
                class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:outline-none focus:border-blue-500 transition"
              />
            </div>

            <div>
              <label class="block text-gray-700 font-semibold mb-3 flex items-center gap-2">
                <span class="w-6 h-6 bg-orange-100 rounded-full flex items-center justify-center text-orange-600 text-sm">⏰</span>
                Heure *
              </label>
              <input
                type="time"
                [(ngModel)]="selectedRdv.heure_rendezvous"
                name="heure_rendezvous"
                required
                class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:outline-none focus:border-blue-500 transition"
              />
            </div>
          </div>

          <!-- Motif -->
          <div>
            <label class="block text-gray-700 font-semibold mb-3 flex items-center gap-2">
              <span class="w-6 h-6 bg-red-100 rounded-full flex items-center justify-center text-red-600 text-sm">📝</span>
              Motif de consultation *
            </label>
            <textarea
              [(ngModel)]="selectedRdv.motif"
              name="motif"
              required
              rows="4"
              placeholder="Décrivez le motif de la consultation (symptômes, suivi, etc.)..."
              class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:outline-none focus:border-blue-500 transition resize-none"
            ></textarea>
          </div>

          <!-- Statut -->
          <div>
            <label class="block text-gray-700 font-semibold mb-3 flex items-center gap-2">
              <span class="w-6 h-6 bg-indigo-100 rounded-full flex items-center justify-center text-indigo-600 text-sm">🎯</span>
              Statut du rendez-vous
            </label>
            <select
              [(ngModel)]="selectedRdv.statut"
              name="statut"
              class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:outline-none focus:border-blue-500 transition"
            >
              <option value="en_attente">⏱️ En attente</option>
              <option value="confirme">✓ Confirmé</option>
              <option value="annule">✗ Annulé</option>
              <option value="termine">✅ Terminé</option>
            </select>
          </div>

          <!-- Boutons d'action -->
          <div class="flex justify-end gap-4 pt-6 border-t border-gray-200">
            <button
              type="button"
              (click)="closeModal()"
              class="px-6 py-3 border-2 border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50 transition font-semibold"
            >
              Annuler
            </button>
            <button
              type="submit"
              [disabled]="!rdvForm.form.valid"
              class="px-6 py-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition font-semibold disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
            >
              <span>{{ editing ? '💾' : '➕' }}</span>
              <span>{{ editing ? 'Mettre à jour' : 'Créer le rendez-vous' }}</span>
            </button>
          </div>
        </form>
      </div>
    </div>
  }
</div>

<style>
  @keyframes fade-in {
    from {
      opacity: 0;
      transform: scale(0.95) translateY(-10px);
    }
    to {
      opacity: 1;
      transform: scale(1) translateY(0);
    }
  }

  .animate-fade-in {
    animation: fade-in 0.3s ease-out;
  }

  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  /* Scrollbar personnalisée pour le modal */
  .overflow-y-auto::-webkit-scrollbar {
    width: 6px;
  }

  .overflow-y-auto::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
  }

  .overflow-y-auto::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 10px;
  }

  .overflow-y-auto::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
  }
</style>
